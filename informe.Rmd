---
title: "Trabajo final Muestreo II"
author: "Fiorella Lúngaro, Emanuelle Marsella y Maximiliano Saldaña"
date: "Diciembre 2021"
output: 
 bookdown::pdf_document2:
    toc: no
    number_sections: false
header-includes:
  - \usepackage{float}
  - \usepackage[spanish]{babel}
editor_options: 
  chunk_output_type: console
---

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  include = TRUE,
  warning = FALSE,
  out.width = '80%',
  fig.align="center"
  )
```



```{r librerias, include=FALSE}

library(tidyverse)
library(srvyr)
library(survey)
library(PracTools)
library(readxl)
library(tidymodels)
```

# Parte 1

```{r}
# Carga la muestra
muestra <- read_xlsx("datos/muestra grupo 2.xlsx")

# Convertir las variables categóricas a su formato correspondiente

muestra <- muestra %>% 
  mutate(across(where(is.double) & !c(ingreso, w0, edad, R), as.factor))

muestra <- muestra %>% 
  mutate(
    edad = cut(edad, breaks=c(0, 14,20,25,30,40,50,60,Inf), right = FALSE)
    )

```

Se calculan las estimaciones puntuales de la tasa de desempleo, la proporción de personas pobres y del ingreso promedio, haciendo uso de los ponderadores originales $w_0$, es decir, sin ajustar por no respuesta. Esta estrategia de cómputo resulta correcta si el esquema de no respuesta que se considera es *Missing Completely at Random* (MCAR), bajo el cual la probabilidad de responder no depende de las variables de interés ni auxiliares y todas las unidad del marco tienen la misma probabilidad de responder (Ferreira y Zoppolo, 2017).

```{r}
# Diseño usando los ponderadores originales, MCAR.
##FPC?
design1 <- muestra %>%
  filter(R==1) %>% 
  as_survey_design(ids = id_hogar, strata = estrato, weights = w0)
```


```{r}
## Tasa de desempleo (desempleados/activos)

#REVISAR ESTO
#Se piensa como un problema de estimación en dominios, nos interesan los desempleados considerando el grupo de los activos.
design1 %>% 
  filter(activo == 1) %>% 
  group_by(desocupado) %>% 
  summarise(tasa_desempleo = survey_mean(deff = TRUE, vartype = c('se','cv')))
```


La estimación puntual de la proporción de desempleados es 0,0824; mientras que el error estándar (la medida que empleamos para medir la variación del estimador entre muestra y muestra) es 0,0033. Otra medida de la calidad de un estimador $\hat{\theta}$ es su coeficiente de variación, que mide su dispersi\'on relativa. Se define como (Zoppollo, x):

$$CV(\hat{\theta}) = \frac{\sqrt{\hat{V}(\hat{\theta})}}{\left|E(\hat{\theta})\right|}$$
Y en el caso del estimador de la proporción de desempleados su estimación es 0,04.
El efecto diseño es una medida que permite comparar la eficiencia en términos de variabilidad del estimador para el diseño utilizado, respecto al diseño aleatorio simple sin reposición que. Siendo $p(s)$ el diseño medible considerado, se define como:

$$Deff(p(s), \hat{\theta}) = \frac{V_{p(s)}(\hat{\theta})}{V_{SI}(\hat{\theta})}$$
En el caso del estimador de la proporción de desempleados su valor es 1,07; lo que indica que en este caso el diseño SI es un 7% más eficiente que el empleado.



```{r}
## Proporción de personas pobres
design1 %>% 
  group_by(pobreza) %>% 
  summarise(prop_pobres = survey_mean(deff = TRUE, vartype = c('se','cv')))
```

En cuanto a la proporción de personas pobres, la estimación puntual es de 0,0811. El error estándar se estima que es 0,004 aproximadamente, mientras que el coeficiente de variación se estima que es 0,05 aproximadamente. La estimación del efecto diseño es 2,84; un elevado valor que indica que el diseño empleado es altamente ineficiente en comparación con el SI, en particular casi tres veces más. 


```{r}
## Ingreso promedio
design1 %>% 
  summarise(ingreso_prom = survey_mean(ingreso, deff = TRUE, vartype = c('se','cv')))
```

La estimación puntual del ingreso promedio es 21799, siendo la estimación de su error estándar 240. Por otro lado, el coeficiente de variación toma el valor 0,011. La estimación del efecto diseño es 0,94 aproximadamente, por lo que en este caso el diseño empelado resulta más eficiente que el SI, un 6% más.  


```{r}

muestra %>% 
  summarise(
    # tasa de no respuesta no ponderada
    nr_np = 1 - mean(R),
    # tasa de no respuesta ponderada
    nr_p = 1 - weighted.mean(R, w0)
  )



summary(muestra$w0)


#considerando por estratos

muestra %>% 
  group_by(estrato) %>% 
  summarise(
    # tasa de no respuesta no ponderada
    nr_np = mean(R),
    # tasa de no respuesta ponderada
    nr_p = weighted.mean(R, w0)
    )


#considerando por departamento

muestra %>% 
  group_by(dpto) %>% 
  summarise(
   # tasa de no respuesta no ponderada
    nr_np = mean(R),
    # tasa de no respuesta ponderada
    nr_p = weighted.mean(R, w0)
    )

#considerando por departamento

muestra %>% 
  group_by(edad) %>% 
  summarise(
   # tasa de no respuesta no ponderada
    nr_np = mean(R),
    # tasa de no respuesta ponderada
    nr_p = weighted.mean(R, w0)
    )
```

La tasa de no respuesta no ponderada es del 47,4% mientras que la ponderada es del 47,6%. El hecho de que ambas tasas de no respuesta sean similares puede deberse a que los pesos $w_0$ no son muy disímiles entre sí, siendo su mínimo 104,4; su media 125.6 y su máximo 162. Al considerar la proporción de no respondentes por estrato se puede apreciar que ocurre lo mismo. En este caso se puede observar que la tasa de no respuesta varía según el estrato considerado, siendo el primero (Montevideo bajo) el que cuenta con la mayor tasa, del 56%, y el doceavo el que cuenta con la menor, del 46%. Estas diferencias se ven reflejadas también al considerar la tasa de no respondentes por departamento. Resultan bastante diferentes las tasas de no respuesta considerando los distintos segmentos de edad, el de 0 a 14 años y el de 60 en adelante son los que presentan menor tasa de no respuesta, siendo las de los primeros 50% (no ponderada) y 49% (ponderada) y 50% (no ponderada y ponderada) la de los segundos. 

# Parte 2

## Ajuste por no respuesta por medio de post-estratos de no respuesta

Bajo el enfoque de no respuesta considerado, el MAR (*Missing at Random*), se trabaja bajo el supuesto de que la no respuesta no depende de las variables de interés, pero sí es completamente explicada por variables auxiliares. Lo que se puede hacer en este caso es construir un modelo de respuesta basado en la información auxiliar (Ferreira y Zoppolo, ). 

Siguiendo este enfoque, una manera de realizar el ajuste es mediante clases de no respuesta, creadas en base a información de las unidades presente en el marco muestral. Se crean $g$ clases y se asume que todas las unidades dentro de cada una de ellas tiene la misma probabilidad de responder, cuya fórmula es:

$$\hat{\phi}_{i,g} = TR_w = \frac{\sum_{i \in R}w_i}{\sum_{i \in s}w_i}, \,\,\,\, i \in g$$
Luego, los ponderadores por no respuesta son: 

$$w_i^{nr} = \frac{1}{\pi_i \times \hat{\phi}_{i,g}}$$
($\pi_i$ son las probabilidad de inclusión originales)

En nuestro caso, la información que podríamos emplear que se encuentra en el marco son los estratos. 

```{r}
ggplot(muestra, aes(x=ingreso, y=estrato))+ geom_boxplot()

# Parecería que el estrato permitiría explicar mejor el ingreso
```

```{r}
ajuste_nr_estrato <-  muestra %>% 
  group_by(estrato) %>% 
  summarise(
    tr = mean(R), 
    tr_w = weighted.mean(R, w0))


muestra <- left_join(muestra , select(ajuste_nr_estrato, estrato, tr_w)) %>%
                mutate(w_nr_post = w0/tr_w)  
```


```{r}
ggplot(muestra) +
 geom_point(aes(w0, w_nr_post, color = estrato))

# los ponderadores originales se ven bastante alterados
```


Una medida global frecuentemente utilizada conocida como efecto diseño debido a la
ponderación o efecto de Kish (Kish, 1965, 1992) y representa el incremento en la variabilidad de los
estimadores por usar ponderadores distintos respecto al uso de el mismo ponderador para todos los
caso y se define como uno más la varianza relativa de los ponderadores,



Una forma de medir la variabilidad global de los ponderadores (que en caso de ser alta puede resultar en una variabilidad alta de los estimadores) es el efecto diseño de Kish, que representa el incremento en la variabilidad de los estimadores causada por usar ponderadores distintos para las unidades de la muestra con respecto a usar el mismo ponderador. Su fórmula es:

$$deff_w = 1 + \frac{1}{n} \frac{\sum_s(w_k - \bar{w})^2}{\bar{w}^2}$$

donde $\bar{w} = n^{-1} \sum_sw_k$ es el promedio de los ponderadores.

La práctica usual es calcularlo luego de realizar cada ajuste a los estimadores (no respuesta, calibración, en el caso de este trabajo). Se usa la regla empírica que $deff_w > 1,5$ indican que hay valores extremos de los ponderadores que repercuten en los finales


```{r}
# Efecto diseño de Kish
deffK(muestra$w_nr_post)
```

En nuestro caso, luego de realizar el ajuste por no respuesta $deff_w \simeq 1,033 < 1,5$, por lo que parecería que no resultó en valores extremos de los ponderadores. 



```{r}
#estimaciones empleando ajuste por no respuesta mediante clases de no respuesta

design2 <- muestra %>%
  filter(R==1) %>% 
  as_survey_design(ids = id_hogar, strata = estrato, weights = w_nr_post)

# Tasa de desempleo
design2 %>% 
  filter(activo == 1) %>% 
  group_by(desocupado) %>% 
  summarise(tasa_desempleo = survey_mean(deff = TRUE, vartype = c('se','cv')))
```

Una vez se realiza el ajuste por no respuesta mediante clases de no respuesta, la estimación puntual de la tasa de desempleo cambia, pasa de 8,24% a 8,31%. El desvío disminuye, pasando de 0,0033 a 0,00336; lo mismo ocurre con el coeficiente de variación, pasando de 0,04 a 0,0404. El efecto diseño pasa de 1,07 a 1,09.

```{r}
## Proporción de personas pobres
design2 %>% 
  group_by(pobreza) %>% 
  summarise(prop_pobres = survey_mean(deff = TRUE, vartype = c('se','cv')))
```

En cuanto a la estimación de la proporción de personas pobres, ahora aumenta de 0,0811 a 0,0837. La estimación del error estándar aumenta a 0,00389, mientras que el coeficiente de vairación no presenta cambio al corregir por no respuesta. El efecto diseño presenta un aumento, de 2,84 a 2,92. 



```{r}
## Ingreso promedio
design2 %>% 
  summarise(ingreso_prom = survey_mean(ingreso, deff = TRUE, vartype = c('se','cv')))
```

La estimación puntual del ingreso promedio disminuye, de 21799 a 21686, el error estándar presenta una disminución en una unidad. El coeficiente de variación con y sin ajuste son iguales hasta 4 lugares después de la coma, mientras que el efecto diseño presenta una leve disminución; pasa de 0,9355 a 0,9314.


## Estimación de propensiones simples de responder utilizando el algoritmo random forest.

El ajuste por propensiones simples consiste en:

$$w_i^{nr} = \frac{1}{\pi_i \times \hat{\phi}_i}$$
donde $\hat{\phi}_i$ es la propensión a responder de la unidad $i$, la cual se estima a partir de un modelo o un algoritmo, haciendo uso de variables auxiliares conocidas tanto para respondentes como no respondentes.

El algoritmo elegido es *Random Forest*, un método no paramétrico mediante el cual se hace uso de múltiples árboles de decisión para obtener una estimación.


```{r}

```





