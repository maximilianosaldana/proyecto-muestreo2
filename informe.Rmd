---
title: "Trabajo final Muestreo II"
author: "Fiorella Lúngaro, Emanuelle Marsella y Maximiliano Saldaña"
date: "Diciembre 2021"
output: 
 bookdown::pdf_document2:
    toc: no
    number_sections: false
header-includes:
  - \usepackage{float}
  - \usepackage[spanish]{babel}
editor_options: 
  chunk_output_type: console
---

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  include = TRUE,
  warning = FALSE,
  out.width = '80%',
  fig.align="center"
  )
```



```{r librerias, include=FALSE}

library(tidyverse)
library(srvyr)
library(survey)
library(PracTools)
library(readxl)

```

# Parte 1

```{r}
# Carga la muestra
muestra <- read_xlsx("datos/muestra grupo 2.xlsx")

# Convertir las variables categóricas a su formato correspondiente

muestra <- muestra %>% 
  mutate(across(where(is.double) & !c(ingreso, w0, edad, R), as.factor))

muestra <- muestra %>% 
  mutate(
    edad = cut(edad, breaks=c(0, 14,20,25,30,40,50,60,Inf), right = FALSE)
    )

```

Se calculan las estimaciones puntuales de la tasa de desempleo, la proporción de personas pobres y del ingreso promedio, haciendo uso de los ponderadores originales $w_0$, es decir, sin ajustar por no respuesta. Esta estrategia de cómputo resulta correcta si el esquema de no respuesta que se considera es *Missing Completely at Random* (MCAR), bajo el cual la probabilidad de responder no depende de las variables de interés ni auxiliares y todas las unidad del marco tienen la misma probabilidad de responder (Ferreira y Zoppolo, 2017).

```{r}
# Diseño usando los ponderadores originales, MCAR.
##FPC?
design1 <- muestra %>%
  filter(R==1) %>% 
  as_survey_design(ids = id_hogar, strata = estrato, weights = w0)
```


```{r}
## Tasa de desempleo (desempleados/activos)

#REVISAR ESTO
#Se piensa como un problema de estimación en dominios, nos interesan los desempleados considerando el grupo de los activos.
design1 %>% 
  filter(activo == 1) %>% 
  group_by(desocupado) %>% 
  summarise(tasa_desempleo = survey_mean(deff = TRUE, vartype = c('se','cv')))


```


La estimación puntual de la proporción de desempleados es 0,0824; mientras que el error estándar (la medida que empleamos para medir la variación del estimador entre muestra y muestra) es 0,0033. Otra medida de la calidad de un estimador $\hat{\theta}$ es su coeficiente de variación, que mide su dispersi\'on relativa. Se define como (Zoppollo, x):

$$CV(\hat{\theta}) = \frac{\sqrt{\hat{V}(\hat{\theta})}}{\left|E(\hat{\theta})\right|}$$
Y en el caso del estimador de la proporción de desempleados su estimación es 0,04.
El efecto diseño es una medida que permite comparar la eficiencia en términos de variabilidad del estimador para el diseño utilizado, respecto al diseño aleatorio simple sin reposición que. Siendo $p(s)$ el diseño medible considerado, se define como:

$$Deff(p(s), \hat{\theta}) = \frac{V_{p(s)}(\hat{\theta})}{V_{SI}(\hat{\theta})}$$
En el caso del estimador de la proporción de desempleados su valor es 1,07; lo que indica que en este caso el diseño SI es un 7% más eficiente que el empleado.



```{r}
## Proporción de personas pobres
design1 %>% 
  group_by(pobreza) %>% 
  summarise(prop_pobres = survey_mean(deff = TRUE, vartype = c('se','cv')))
```

En cuanto a la proporción de personas pobres, la estimación puntual es de 0,0811. El error estándar se estima que es 0,004 aproximadamente, mientras que el coeficiente de variación se estima que es 0,05 aproximadamente. La estimación del efecto diseño es 2,84; un elevado valor que indica que el diseño empleado es altamente ineficiente en comparación con el SI, en particular casi tres veces más. 


```{r}
## Ingreso promedio
design1 %>% 
  summarise(ingreso_prom = survey_mean(ingreso, deff = TRUE, vartype = c('se','cv')))
```

La estimación puntual del ingreso promedio es 21799, siendo la estimación de su error estándar 240. Por otro lado, el coeficiente de variación toma el valor 0,011. La estimación del efecto diseño es 0,94 aproximadamente, por lo que en este caso el diseño empelado resulta más eficiente que el SI, un 6% más.  


```{r}

muestra %>% 
  summarise(
    # tasa de no respuesta no ponderada
    nr_np = 1 - mean(R),
    # tasa de no respuesta ponderada
    nr_p = 1 - weighted.mean(R, w0)
  )



summary(muestra$w0)


#considerando por estratos

muestra %>% 
  group_by(estrato) %>% 
  summarise(
    # tasa de no respuesta no ponderada
    nr_np = mean(R),
    # tasa de no respuesta ponderada
    nr_p = weighted.mean(R, w0)
    )


#considerando por departamento

muestra %>% 
  group_by(dpto) %>% 
  summarise(
   # tasa de no respuesta no ponderada
    nr_np = mean(R),
    # tasa de no respuesta ponderada
    nr_p = weighted.mean(R, w0)
    )

#considerando por departamento

muestra %>% 
  group_by(edad) %>% 
  summarise(
   # tasa de no respuesta no ponderada
    nr_np = mean(R),
    # tasa de no respuesta ponderada
    nr_p = weighted.mean(R, w0)
    )
```

La tasa de no respuesta no ponderada es del 47,4% mientras que la ponderada es del 47,6%. El hecho de que ambas tasas de no respuesta sean similares puede deberse a que los pesos $w_0$ no son muy disímiles entre sí, siendo su mínimo 104,4; su media 125.6 y su máximo 162. Al considerar la proporción de no respondentes por estrato se puede apreciar que ocurre lo mismo. En este caso se puede observar que la tasa de no respuesta varía según el estrato considerado, siendo el primero (Montevideo bajo) el que cuenta con la mayor tasa, del 56%, y el doceavo el que cuenta con la menor, del 46%. Estas diferencias se ven reflejadas también al considerar la tasa de no respondentes por departamento. Resultan bastante diferentes las tasas de no respuesta considerando los distintos segmentos de edad, el de 0 a 14 años y el de 60 en adelante son los que presentan menor tasa de no respuesta, siendo las de los primeros 50% (no ponderada) y 49% (ponderada) y 50% (no ponderada y ponderada) la de los segundos. 

# Parte 2

## Ajuste por no respuesta por medio de post-estratos de no respuesta

```{r}


ggplot(muestra, aes(x=ingreso, y=edad, fill=edad))+ geom_boxplot()
ggplot(muestra, aes(x=ingreso, y=sexo, fill=sexo))+ geom_boxplot()

# Parecería que la edad permitiría explicar mejor el ingreso
```

```{r}
#Conteos poblacionales de las variables para post-estratificar
pop_count_edad <- muestra %>% count(edad) %>% rename(Freq=n)


#post-estratificación, se usa únicamente la edad como variable de post-estratificación
post <- postStratify(
  design = design1, 
  strata = ~edad, 
  population=pop_count_edad
  ) 
```

Bajo el enfoque de no respuesta considerado, el MAR (*Missing at Random*), se trabaja bajo el supuesto de que la no respuesta no depende de las variables de interés, pero sí es completamente explicada por variables auxiliares. Lo que se puede hacer en este caso es construir un modelo de respuesta basado en la información auxiliar (Ferreira y Zoppolo, ). En nuestro caso, en un principio consideramos que la no respuesta es explicada por la edad, tomando en cuenta las diferencias en la tasa de no respuesta por segmento. 




```{r}
# Efecto diseño de Kish
deffK(weights(post))
```





